# Basic CI/CD 

<br>

## Install and settings gitlab-runner

<br>

== INSTALL ==

- 1) sudo curl -L --output /usr/local/bin/gitlab-runner "https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64"<br>

Скачиваем бинарный фаил ранера <br>

- 2) sudo chmod +x /usr/local/bin/gitlab-runner <br>

Выдача прав для коректной дальнейшей работы ранера <br>

- 3) sudo useradd --comment 'GitLab Runner' --create-home gitlab-runner --shell /bin/bash <br>

Создания пользователя для ранера, для его взаимодействия с консолью <br>

- 4) sudo gitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner <br>

Установка ранера в указаную деректорию и привязка ранее созданого юзера <br>

- 5) sudo gitlab-runner start <br>

Запуск гитлаб ранера <br>

- 6) sudo systemctl enable --now gitlab-runner <br>

Настройка автозапуска ранера <br>

![Результат выполнения команд](/images/i1.png)<br>*Результат выполнения команд*<br>

  == Регистрация gitlab-runner ==

<br>

- 1) sudo gitlab-runner register<br>

![Результат выполнения команд](/images/i2.png)<br>*Результат выполнения команды*<br>

- 2) sudo gitlab-runner verify <br>

![Результат выполнения команд](/images/i3.png)<br>*Результат выполнения команды*<br>

- 3) sudo gitlab-runner run <br>

![Результат выполнения команд](/images/i4.png)<br>*Результат выполнения команды*<br>
*Так как билдов нету, то ничего не запустилось*<br>

- 4) sudo rm /home/gitlab-runner/.bash_logout (необходимо удаление, скорее всего наличие логов мешает повторным запускам под новыми логами) <br>

- 5) service gitlab-runner status <br>
![Результат выполнения команд](/images/i5.png)<br>*Результат выполнения команды*<br>

<br>

## Step Build

<br>

![Результат выполнения команд](/images/i6.png)<br>*Конфигурация .gitlab-ci.yml файла на этапе build*<br>

- stages: Перечисление этапов сборки при запуске ранера <br>

- building: Создаём область настройки этапа building <br>
- - stage: Пирвязавыем имя build к этапу building для коректного вызова из stages <br>
- - tags: присвоение тега build к этапу building <br>
- - script: Скрипт выполнение дествий нужных для этапа build, если все шаги из script выполнены верно то этап считается пройденым <br>
- - artifacts: Область настройки сохранения иполняемых файлов в архив <br>
- - - paths: Указание путей из которых будут забираться исполняемые файлы для сохранения<br>
- - expire_in: Срок хранения исполняемых файлов в архивах <br>

## Step Codestyle 

![Результат выполнения команд](/images/i7.png)<br>*Конфигурация .gitlab-ci.yml файла на этапе codestyle*<br>

### Промежуточный этап

![Результат выполнения команд](/images/i8.png)<br>*Состояние упешно выполненых pipeline*<br>

![Результат выполнения команд](/images/i9.png)<br>*Внутрений внешний вид pipeline. В самом низу есть возможность перезапускай определёного степа pipelene*<br>

## Step Test_code

![Результат выполнения команд](/images/i10.png)<br>*Конфигурация .gitlab-ci.yml файла на этапе test_code*<br>

- when: Условия для запуска этапа (возможно я не прав), настройка on_success  даёт запустится только если старые шаги прошли успешно

## Step Deploy

![Результат выполнения команд](/images/i11.png)<br>*Конфигурация .gitlab-ci.yml файла на этапе test_code*<br>

- when: Условия для запуска этапа (возможно я не прав), настройка always запускает шаг независимо от состояния заданий на более ранних этапах, настройка manual запускает шаг только в ручную <br>

<br>

-  создаём порты на обоих машинах

 - - Для машины deploy: Настройки > Сеть > Тип подключения "Nat" > Допольнительно > Проброс портов > Добавить новый порт > Имя "ssh", Протокол TCP, Адрес хоста " ", Порт хоста "9002", Адрес гостя " ", Порт гостя "22" Так же: Добавить Адаптер > Внутренняя сеть, имя "intnet" <br>

- - Для машины CI-CD: Настройки > Сеть > Тип подключения "Nat" > Допольнительно > Проброс портов > Добавить новый порт > Имя "ssh", Протокол TCP, Адрес хоста " ", Порт хоста "2222", Адрес гостя " ", Порт гостя "22" Так же: Добавить Адаптер > Внутренняя сеть, имя "intnet" <br>

![Результат выполнения команд](/images/i12.png)<br>*Конфигурация netplan для соеденения машин*<br>

- необходимо после прописать *sudo netplan apply* на обоих машинах после изменения конфигураций <br>

![Результат выполнения команд](/images/i13.png)<br>*выполнение необходимх команд на обих машинах*<br>

- sudo su - gitlab-runner: переключаемся на пользователя ранера <br>

- ssh-keygen -t rsa -b 2048: Генерируем ssh с ограничение в 2048 <br>

- ssh-copy-id -i ~/.ssh/id_rsa.pub zen@10.10.0.2: проводим копирование ключа с машины CI-CD на машину deploy по ip <br>

- sudo chmod -R 777 /usr/local/bin/: выдём права на машине deploy на пользование директорие нужной для сохранения артефактов <br>

## Step Bot

<br>

![Результат выполнения команд](/images/i14.png)<br>*Скрипт необходимый для запуска бота*<br>

- TELEGRAM_BOT_TOKEN: Токен самого бота <br>

- TELEGRAM_USER_ID: Токен тг юзера <br>

- URL: Ссылка на отчет ранера  <br>

- TEXT: Текст сообщения  <br>

<br><br>

- В каждый этап ранера добавляем after_script <br>

- - after_script: Путь исполяемого скрипта необходимого для работы бота <br>

## Итог

<br>

![Результат выполнения команд](/images/i15.png)<br>*Отроботка всех pipelines*<br>
